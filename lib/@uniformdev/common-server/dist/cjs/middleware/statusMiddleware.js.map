{"version":3,"file":"statusMiddleware.js","sourceRoot":"","sources":["../../../src/middleware/statusMiddleware.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,yBAA8C;AAI9C,wBAA0C;AAC1C,0DAA+B;AAE/B,SAAgB,sBAAsB,CAAC,MAAW,EAAE,aAAkC,EAAE,MAAc;IAClG,MAAM,CAAC,GAAG,CAAC,6BAA6B,EAAE,mBAAmB,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC,CAAC;AAC1F,CAAC;AAFD,wDAEC;AAED,SAAgB,mBAAmB,CAAC,aAAkC,EAAE,MAAc;IAClF,IAAM,KAAK,GAAG,aAAa,CAAC,iBAAiB,CAAC;IAE9C,OAAO,UAAgB,GAAQ,EAAE,GAAQ;;;;;;wBACrC,MAAM,CAAC,IAAI,CAAC,+CAA+C,CAAC,CAAC;wBACvD,YAAY,GAAG,GAAG,CAAC,KAAK,CAAC,eAAe,CAAC,IAAI,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;wBAEtE,IAAI,KAAK,IAAI,YAAY,KAAK,KAAK,EAAE;4BACjC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;4BACpB,MAAM,CAAC,IAAI,CAAC,wCAAwC,CAAC,CAAC;4BACtD,sBAAO;yBACV;wBAEK,WAAW,GAAM,aAAa,CAAC,eAAe,qCAAkC,CAAC;wBAC5E,qBAAM,oBAAK,CAAC,WAAW,CAAC,EAAA;;wBAA7B,EAAE,GAAG,SAAwB;wBACnC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;4BACF,GAAG,GAAG,mCAAiC,WAAa,CAAC;4BAC3D,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;4BAC1B,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;4BAEjB,sBAAO;yBACV;wBAEK,GAAG,GAAG,aAAa,CAAC,MAAM,CAAC,CAAC;wBAElC,GAAG,CAAC,IAAI,CAAC;4BACL,MAAM,EAAE,OAAO;4BACf,OAAO,EAAE,wBAAoB,CAAC,MAAM,CAAC,IAAI,SAAS;4BAClD,UAAU,EAAE,CAAA,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,OAAO,KAAI,EAAE;4BAC9B,cAAc,EAAE,CAAA,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,WAAW,KAAI,EAAE;yBACzC,CAAC,CAAC;;;;;KACN,CAAC;AACN,CAAC;AAhCD,kDAgCC;AAED,SAAgB,aAAa,CAAC,MAAc;IACxC,IAAM,eAAe,GAAG,gBAAgB,CAAC;IACzC,IAAI,CAAC,eAAU,CAAC,eAAe,CAAC,EAAE;QAC9B,OAAO,IAAI,CAAC;KACf;IAED,IAAI;QACA,OAAO,IAAI,CAAC,KAAK,CAAC,iBAAY,CAAC,eAAe,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;KAC/D;IAAC,OAAO,EAAE,EAAE;QACT,MAAM,CAAC,KAAK,CAAC,8BAA8B,GAAG,eAAe,CAAC,CAAC;QAE/D,MAAM,EAAE,CAAC;KACZ;AACL,CAAC;AAbD,sCAaC","sourcesContent":["import { readFileSync, existsSync } from 'fs';\r\n\r\nimport { Logger } from '@uniformdev/common';\r\nimport { UniformServerConfig } from '..';\r\nimport { tryGetUniformVersion } from '..';\r\nimport fetch from 'node-fetch';\r\n\r\nexport function attachStatusMiddleware(server: any, uniformConfig: UniformServerConfig, logger: Logger) {\r\n    server.get('/uniform/api/service/status', getStatusMiddleware(uniformConfig, logger));\r\n}\r\n\r\nexport function getStatusMiddleware(uniformConfig: UniformServerConfig, logger: Logger) {\r\n    const token = uniformConfig.UNIFORM_API_TOKEN;\r\n\r\n    return async function (req: any, res: any) {\r\n        logger.info('Received service status (and version) request');\r\n        const requestToken = req.query['uniform_token'] || req.query['token'];\r\n\r\n        if (token && requestToken !== token) {\r\n            res.sendStatus(401);\r\n            logger.warn('Unauthorized request has been rejected');\r\n            return;\r\n        }\r\n\r\n        const sitecoreUrl = `${uniformConfig.UNIFORM_API_URL}/sitecore/service/keepalive.aspx`;\r\n        const rs = await fetch(sitecoreUrl);\r\n        if (!rs.ok) {\r\n            const err = `Sitecore does not respond at: ${sitecoreUrl}`;\r\n            res.status(503).send(err);\r\n            logger.warn(err);\r\n\r\n            return;\r\n        }\r\n\r\n        const app = tryGetAppInfo(logger);\r\n\r\n        res.json({\r\n            status: 'ready',\r\n            version: tryGetUniformVersion(logger) || 'unknown',\r\n            appVersion: app?.version || '',\r\n            appDescription: app?.description || '',\r\n        });\r\n    };\r\n}\r\n\r\nexport function tryGetAppInfo(logger: Logger): { version?: string; description?: string } | null {\r\n    const packageFilePath = './package.json';\r\n    if (!existsSync(packageFilePath)) {\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        return JSON.parse(readFileSync(packageFilePath).toString());\r\n    } catch (ex) {\r\n        logger.error('Failed to deserialize file: ' + packageFilePath);\r\n\r\n        throw ex;\r\n    }\r\n}\r\n"]}