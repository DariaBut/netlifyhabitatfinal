{"version":3,"file":"getPageProps.js","sourceRoot":"","sources":["../../../src/utils/getPageProps.ts"],"names":[],"mappings":"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","sourcesContent":["import { fetchWithRetry } from '@uniformdev/common';\r\n\r\nimport { parseGuid } from '@uniformdev/common';\r\n\r\nimport { Logger, UniformConfig } from '@uniformdev/common';\r\n\r\nimport { DataItem, PageItem } from '..';\r\n\r\nimport { getPageUrl } from './getPageUrl';\r\nimport { convertDataItemToRuntimeItem } from './convertDataItemToRuntimeItem';\r\nimport { noopLogger } from './noopLogger';\r\n\r\ntype _fetch = typeof fetch;\r\n\r\nexport async function getPageItem(fetch: _fetch, path: string, logger: Logger, config: UniformConfig): Promise<PageItem> {\r\n    return await getDataItem(fetch, path, 'page', logger, config);\r\n}\r\n\r\nconst readFileAsync =\r\n    typeof window === 'undefined' ? eval(\"(require('util').promisify)(require('fs').readFile)\") : undefined;\r\nconst existsAsync =\r\n    typeof window === 'undefined' ? eval(\"(require('util').promisify)(require('fs').exists)\") : undefined;\r\n\r\nexport async function getDataItem(\r\n    fetch: _fetch,\r\n    path: string,\r\n    type: string,\r\n    logger: Logger,\r\n    config: UniformConfig\r\n): Promise<DataItem> {\r\n    if (readFileAsync && existsAsync) {\r\n        let filename = 'public/uniform/api/content/' + config.UNIFORM_API_SITENAME + '/' + type + path;\r\n        if (filename.endsWith('/')) {\r\n            filename = filename.substring(0, filename.length - 1);\r\n        }\r\n\r\n        if (await existsAsync(filename)) {\r\n            return JSON.parse((await readFileAsync(filename)).toString());\r\n        }\r\n    }\r\n\r\n    let itemUrl = getPageUrl(path, type, config);\r\n    logger.debug('Making HTTP request (data): ' + itemUrl);\r\n    let response = await fetchWithRetry(fetch, logger, itemUrl, 3);\r\n\r\n    if (response.status !== 200) {\r\n        throw new Error(\r\n            'No item, ajax request to ' +\r\n                response.url +\r\n                ' returned ' +\r\n                response.status +\r\n                ' code, text: ' +\r\n                response.statusText\r\n        );\r\n    }\r\n\r\n    const item = await response.json();\r\n    if (!item.id) throw new Error('no item.id, ' + itemUrl + ', ' + JSON.stringify(item));\r\n\r\n    return convertDataItemToRuntimeItem(item, undefined, path);\r\n}\r\n\r\nexport async function getDatasources(page: PageItem) {\r\n    const pageDatasources = page.datasources || {};\r\n\r\n    const datasources: any = {};\r\n\r\n    for (const id in pageDatasources) {\r\n        if (!pageDatasources.hasOwnProperty(id)) continue;\r\n\r\n        const datasource = convertDataItemToRuntimeItem(pageDatasources[id], undefined, undefined);\r\n        const guid: string = parseGuid(id);\r\n\r\n        datasources[guid] = datasource;\r\n    }\r\n\r\n    return datasources;\r\n}\r\n\r\nexport async function getHtml(page: PageItem) {\r\n    return page.mvc?.html || {};\r\n}\r\n\r\nexport interface PageProps {\r\n    item?: PageItem;\r\n    page?: PageItem;\r\n    home?: DataItem;\r\n    datasources: any;\r\n    html: any;\r\n    path?: string;\r\n}\r\n\r\nexport async function getPageProps(\r\n    fetch: _fetch,\r\n    asPath: string,\r\n    config: UniformConfig,\r\n    logger: Logger = noopLogger\r\n): Promise<PageProps> {\r\n    logger.debug(`Rendering page with path: ${asPath}`);\r\n\r\n    if (asPath && asPath.startsWith('/-')) throw new Error('Must not be handled by page!');\r\n\r\n    const path = asPath + (asPath.endsWith('/') ? '' : '/');\r\n\r\n    // item\r\n    const item = await getPageItem(fetch, path, logger, config);\r\n\r\n    // home\r\n    const home = item; // TODO: remove home api completely\r\n\r\n    // datasources\r\n    const datasources = await getDatasources(item);\r\n\r\n    // html\r\n    const html = await getHtml(item);\r\n\r\n    if (!item) {\r\n        throw new Error('No context item passed');\r\n    }\r\n\r\n    logger.debug(`Resolved page '${path}'`);\r\n\r\n    const props: PageProps = {\r\n        datasources,\r\n        html,\r\n        item,\r\n        page: item,\r\n        home,\r\n        path,\r\n    };\r\n    return props;\r\n}\r\n"]}